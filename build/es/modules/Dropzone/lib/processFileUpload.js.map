{"version":3,"file":"processFileUpload.js","sources":["../../../../../src/react/modules/Dropzone/lib/processFileUpload.ts"],"sourcesContent":["import PQueue from 'p-queue';\n\nimport { DropzoneFile, DropzoneHelpers, DropzoneProps } from '../Dropzone.types';\n\n\nexport type ProcessFileHandler = (file: DropzoneFile, helpers: DropzoneHelpers) => Promise<void>;\n\nexport interface ProcessFileUploadConfig {\n  /** Set if must auto control file state */\n  autoControlFileState?: boolean;\n\n  /** Auto remove file timeout */\n  autoRemoveUploadedTimeout?: number;\n\n  /** Set concurrency upload */\n  concurrency?: number;\n\n  /** Handler to call on single file upload end */\n  onFileUploadEnd?: (file: DropzoneFile, helpers: DropzoneHelpers) => void;\n\n  /** On file upload error handler */\n  onFileUploadError?: (file: DropzoneFile, helpers: DropzoneHelpers) => void;\n}\n\nexport default function processFileUpload(\n  handler: ProcessFileHandler,\n  config?: ProcessFileUploadConfig\n): DropzoneProps['onUpload'] {\n\n  const {\n    autoControlFileState = true,\n    autoRemoveUploadedTimeout = 1000,\n    concurrency = 3,\n    onFileUploadEnd,\n    onFileUploadError\n  } = config ?? {};\n\n  return async function uploadFiles(files: DropzoneFile[], helpers: DropzoneHelpers) {\n\n    /** Initialize the Queue */\n    const queue = new PQueue({\n      concurrency\n    });\n\n    files.forEach((file) => {\n      queue.add(() => new Promise<void>((resolve) => {\n        /** Set file uploading */\n        if (autoControlFileState) {\n          helpers.setFilesState([ file ], {\n            isUploading: true,\n            error      : false,\n            success    : false\n          });\n        }\n\n        /** Call the handler */\n        handler(file, helpers)\n          .then(() => {\n            /** Set the new file state */\n            if (autoControlFileState) {\n              helpers.setFilesState([ file ], {\n                isUploading: false,\n                error      : false,\n                success    : true\n              });\n\n              if (autoRemoveUploadedTimeout) {\n                setTimeout(() => {\n                  helpers.removeFiles([ file ]);\n                }, autoRemoveUploadedTimeout);\n              }\n            }\n\n            /** Call the onUploadEnd handler */\n            if (onFileUploadEnd) {\n              onFileUploadEnd(file, helpers);\n            }\n\n            /** Resolve the queue task */\n            return resolve();\n          })\n          .catch(() => {\n            /** Set the new file state */\n            if (autoControlFileState) {\n              helpers.setFilesState([ file ], {\n                isUploading: false,\n                error      : true,\n                success    : false\n              });\n            }\n\n            /** Call the onUploadError handler */\n            if (onFileUploadError) {\n              onFileUploadError(file, helpers);\n            }\n\n            /** Resolve the task anyway */\n            return resolve();\n          });\n\n      }));\n    });\n\n    /** Await the queue idle */\n    await queue.onIdle();\n  };\n\n}\n"],"names":["PQueue"],"mappings":";;;;;;;;;SAwBwB,iBAAiB,CACvC,OAA2B,EAC3B,MAAgC;IAG1B,IAAA,KAMF,MAAM,aAAN,MAAM,cAAN,MAAM,GAAI,EAAE,EALd,4BAA2B,EAA3B,oBAAoB,mBAAG,IAAI,KAAA,EAC3B,iCAAgC,EAAhC,yBAAyB,mBAAG,IAAI,KAAA,EAChC,mBAAe,EAAf,WAAW,mBAAG,CAAC,KAAA,EACf,eAAe,qBAAA,EACf,iBAAiB,uBACH,CAAC;IAEjB,OAAO,SAAe,WAAW,CAAC,KAAqB,EAAE,OAAwB;;;;;;wBAGzE,KAAK,GAAG,IAAIA,0BAAM,CAAC;4BACvB,WAAW,aAAA;yBACZ,CAAC,CAAC;wBAEH,KAAK,CAAC,OAAO,CAAC,UAAC,IAAI;4BACjB,KAAK,CAAC,GAAG,CAAC,cAAM,OAAA,IAAI,OAAO,CAAO,UAAC,OAAO;;gCAExC,IAAI,oBAAoB,EAAE;oCACxB,OAAO,CAAC,aAAa,CAAC,CAAE,IAAI,CAAE,EAAE;wCAC9B,WAAW,EAAE,IAAI;wCACjB,KAAK,EAAQ,KAAK;wCAClB,OAAO,EAAM,KAAK;qCACnB,CAAC,CAAC;iCACJ;;gCAGD,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC;qCACnB,IAAI,CAAC;;oCAEJ,IAAI,oBAAoB,EAAE;wCACxB,OAAO,CAAC,aAAa,CAAC,CAAE,IAAI,CAAE,EAAE;4CAC9B,WAAW,EAAE,KAAK;4CAClB,KAAK,EAAQ,KAAK;4CAClB,OAAO,EAAM,IAAI;yCAClB,CAAC,CAAC;wCAEH,IAAI,yBAAyB,EAAE;4CAC7B,UAAU,CAAC;gDACT,OAAO,CAAC,WAAW,CAAC,CAAE,IAAI,CAAE,CAAC,CAAC;6CAC/B,EAAE,yBAAyB,CAAC,CAAC;yCAC/B;qCACF;;oCAGD,IAAI,eAAe,EAAE;wCACnB,eAAe,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;qCAChC;;oCAGD,OAAO,OAAO,EAAE,CAAC;iCAClB,CAAC;qCACD,KAAK,CAAC;;oCAEL,IAAI,oBAAoB,EAAE;wCACxB,OAAO,CAAC,aAAa,CAAC,CAAE,IAAI,CAAE,EAAE;4CAC9B,WAAW,EAAE,KAAK;4CAClB,KAAK,EAAQ,IAAI;4CACjB,OAAO,EAAM,KAAK;yCACnB,CAAC,CAAC;qCACJ;;oCAGD,IAAI,iBAAiB,EAAE;wCACrB,iBAAiB,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;qCAClC;;oCAGD,OAAO,OAAO,EAAE,CAAC;iCAClB,CAAC,CAAC;6BAEN,CAAC,GAAA,CAAC,CAAC;yBACL,CAAC,CAAC;;wBAGH,qBAAM,KAAK,CAAC,MAAM,EAAE,EAAA;;;wBAApB,SAAoB,CAAC;;;;;KACtB,CAAC;AAEJ;;;;"}